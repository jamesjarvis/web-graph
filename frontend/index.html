<head>
  <style> body { margin: 0; } </style>

  <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone"></script>

  <script src="https://unpkg.com/react-force-graph-2d"></script>
  <!--<script src="../../src/packages/react-force-graph-3d/dist/react-force-graph-3d.js"></script>-->

  <!-- <script src="../datasets/random-data.js"></script> -->
</head>

<body>
<div id="graph"></div>

<script type="text/jsx">
  const { useState, useMemo, useCallback } = React;
  const initialData = {
    "nodes": [
      {
        "id": "ABC",
        "group": "jamesjarvis.io",
        "url": "https://jamesjarvis.io",
      },
      {"id": "DEF", "group": "unknown", "url": "unknown"},
      {"id": "GHI", "group": "unknown", "url": "unknown"},
    ],
    "links": [
      {"source": "ABC", "target": "DEF"},
      {"source": "ABC", "target": "GHI"},
    ]
  }
  let nodeInfoMap = new Map([
    ['ABC', {
      "node": {
        "id": "ABC",
        "group": "jamesjarvis.io",
        "url": "https://jamesjarvis.io",
      },
      "links": [
        "DEF",
        "GHI",
      ]
    }],
    ['DEF', {
      "node": {
        "id": "DEF",
        "group": "wikipedia.com",
        "url": "https://wikipedia.com/united-kingdom",
      },
      "links": [
        "GHI",
      ]
    }],
    ['GHI', {
      "node": {
        "id": "GHI",
        "group": "wikipedia.com",
        "url": "https://wikipedia.com/phone-box",
      },
      "links": [
        "DEF",
        "JKL",
      ]
    }],
    ['JKL', {
      "node": {
        "id": "JKL",
        "group": "google.com",
        "url": "https://google.com/bullshit",
      },
      "links": [
        "MNO",
      ]
    }],
    ['MNO', {
      "node": {
        "id": "MNO",
        "group": "someblog.com",
        "url": "https://someblog.com/bullshit",
      },
      "links": [
        "ABC",
      ]
    }]
  ]);

  let loadedNodeMap = new Map([
    [initialData.nodes[0].id, true],
  ]);
  let linkMap = new Map([
    [initialData.nodes[0].id, true],
  ]);
  initialData.links.forEach((link) => {
    linkMap.set(link.target, true);
  })

  const ExpandableGraph = () => {
    const [data, setData] = useState(initialData);

    // getNodeInfo takes the id of a node, and retrieves it's info.
    const getNodeInfo = (nodeID) => {
      return nodeInfoMap.get(nodeID);
    }

    const handleNodeClick = useCallback(node => {
      if (!loadedNodeMap.has(node.id)) {
        // If this node has not been loaded yet, then load the new data into the graph.
        loadedNodeMap.set(node.id, true);
        let tempData = {
          "nodes": data.nodes,
          "links": data.links,
        };

        let addingNodeData = getNodeInfo(node.id);
        if (!addingNodeData) {
          console.log("nothing found");
          return
        }

        // The node has not been loaded, so we need to go through the existing data.
        const objIndex = tempData.nodes.findIndex((n => n.id == node.id));
        // Update node properties.
        tempData.nodes[objIndex].id = addingNodeData.node.id;
        tempData.nodes[objIndex].group = addingNodeData.node.group;
        tempData.nodes[objIndex].color = null;


        addingNodeData.links.forEach((item) => {
          if (!linkMap.has(item)) {
            console.log("node being linked to has not been added yet", item);
            linkMap.set(item, true);
            tempData.nodes.push({
              "id": item,
              "group": "unknown",
            })
          }
          tempData.links.push(
            {
              "source": addingNodeData.node.id,
              "target": item,
            }
          )
        });

        setData(tempData);
      } else {
        console.log("already added node");
      }
    }, []);

    return <ForceGraph2D
      graphData={data}
      nodeAutoColorBy="group"
      linkDirectionalParticles={1}
      onNodeClick={handleNodeClick}
    />;
  };

  ReactDOM.render(
    <ExpandableGraph/>,
    document.getElementById('graph')
  );
</script>
</body>
