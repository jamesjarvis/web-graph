<head>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    .info {
      position: absolute;
      left: 20px;
      top: 20px;
      z-index: 999999;

      border-radius: 15px;
      padding: 10px;
      padding-bottom: 0;

      background-color: #CFE2FC;
      background-image:
         radial-gradient(ellipse farthest-corner at 80vw 15vh ,
          rgba( 250, 240, 128, 0.5) 5%, rgba( 250,240,128,0) 95%
      );
      opacity: 0.9;
    }
    footer {
      font-size: 10px;
      text-align: center;

      position: absolute;
      z-index: -1;
      bottom: 0px;
      
      width: 100%;
    }
  </style>

  <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone"></script>

  <script src="https://unpkg.com/react-force-graph-2d"></script>
  <script src="https://unpkg.com/axios@v0.21.1/dist/axios.min.js"></script>


  <!--<script src="../../src/packages/react-force-graph-3d/dist/react-force-graph-3d.js"></script>-->

  <!-- <script src="../datasets/random-data.js"></script> -->
</head>

<body>
<div id="graph"></div>

<script type="text/jsx">
  const { useState, useCallback, useEffect } = React;

  const apiURL = "https://api.jamesjarvis.io"
  // const apiURL = "http://192.168.68.144"

  const emptyData = {
    "nodes": [],
    "links": [],
  }
  let loadedNodeMap = new Map();
  let linkMap = new Map();

  const ExpandableGraph = () => {
    const [currentPage, setCurrentPage] = useState("5bc63ce53c8aaede0889ee9e90276affbbba7573")
    const [selectedNode, setSelectedNode] = useState()
    const [data, setData] = useState(emptyData);

    const updateData = (newData, existingID) => {
      let tempData = {
        "nodes": data.nodes,
        "links": data.links,
      };

      if (tempData.nodes.length == 0) {
        // If the data is being added for the first time, we initialise the first node here.
        linkMap.set(newData.node.id, true);
        let linksFrom = 0;
        if (newData.links) {
          linksFrom = newData.links.length;
        }
        tempData.nodes.push({
          "id":     newData.node.id,
          "group:": newData.node.group,
          "url":    newData.node.url,
          "linksFrom":  linksFrom,
          "color":  null,
        })
      } else {
        // The node has not been loaded, so we need to go through the existing data.
        const objIndex = tempData.nodes.findIndex((n => n.id == existingID));
        // Update node properties.
        let linksFrom = 0;
        if (newData.links) {
          linksFrom = newData.links.length;
        }
        tempData.nodes[objIndex].id = newData.node.id;
        tempData.nodes[objIndex].group = newData.node.group;
        tempData.nodes[objIndex].url = newData.node.url;
        tempData.nodes[objIndex].linksFrom = linksFrom;
        tempData.nodes[objIndex].color = null;
      }


      if (newData.links) {
        newData.links.forEach((item) => {
          if (!linkMap.has(item)) {
            // console.log("node being linked to has not been added yet", item);
            linkMap.set(item, true);
            tempData.nodes.push({
              "id": item,
              "group": "unknown",
            })
          }
          tempData.links.push(
            {
              "source": newData.node.id,
              "target": item,
            }
          )
        });
      }

      setData(tempData);
    }

    // getNodeInfo takes the id of a node, and retrieves it's info.
    const getNodeInfo = (nodeID) => {
      axios.get(apiURL+'/page/'+nodeID)
    	  .then(function (response) {
          let linksFrom = 0;
          if (response.data.links) {
            linksFrom = response.data.links.length;
          }
          response.data.node.linksFrom = linksFrom;
          setSelectedNode(response.data.node);
          updateData(response.data, nodeID);
    	  })
    	  .catch(function (error) {
          console.log("nothing found")
    	    console.log(error);
    	  });
    }

    // This is called on page load to get the initial data.
    const updateInitialPageData = useEffect(() => {
      loadedNodeMap.set(currentPage, true);
      getNodeInfo(currentPage)
    }, [currentPage])

    // This is called every time each node is clicked on.
    const handleNodeClick = useCallback(node => {
      if (!loadedNodeMap.has(node.id)) {
        // If this node has not been loaded yet, then load the new data into the graph.
        loadedNodeMap.set(node.id, true);
        getNodeInfo(node.id);
      } else {
        setSelectedNode(node);
        console.log("already added node");
      }
    }, []);

    return <div>
      {selectedNode &&
        <div className="info">
          <a href={selectedNode.url}>{selectedNode.url}</a>
          <p>has {selectedNode.linksFrom}{selectedNode.linksFrom >=100 && "+"} links</p>
        </div>
      }
      <ForceGraph2D
        graphData={data}
        nodeAutoColorBy="group"
        linkDirectionalParticles={1}
        onNodeClick={handleNodeClick}
      />
      <footer>
        <p>Click on nodes to follow links. Links from the same host (ie: en.wikipedia.org) are grouped by colour. Blue nodes are unexplored.</p>
      </footer>
    </div>;
  };

  ReactDOM.render(
    <ExpandableGraph/>,
    document.getElementById('graph')
  );
</script>
</body>
